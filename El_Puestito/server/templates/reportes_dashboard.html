<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ventas</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/socket.io.min.js"></script>

    <style>
        .dashboard-container {
            padding: 40px;
            overflow-y: auto;
            height: calc(100vh - 80px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: #1e1e24;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .chart-title {
            color: #8b8d91;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .big-number {
            font-size: 42px;
            font-weight: 800;
            color: #00d26a;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #8b8d91;
            font-size: 14px;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .dark-input {
            background: #2b2b2b;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 8px;
            color-scheme: dark;
        }
        .filter-btn {
            background: #f76606;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .filter-btn:hover { background: #d65500; }
    </style>
</head>
<body>
    <header class="kds-header">
        <div class="header-left">
            <h1>El Puestito <span class="tag-area" style="color: #00d26a; border-color: #00d26a;">Analytics</span></h1>
        </div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="date" id="dateStart" class="dark-input">
            <span style="color: white;">a</span>
            <input type="date" id="dateEnd" class="dark-input">
            <button onclick="applyFilter()" class="filter-btn">Filtrar</button>
        </div>

        <button onclick="window.close()" class="logout-btn" style="margin-left: 20px;">Cerrar</button>
    </header>

    <div class="dashboard-container">
        <div class="stats-grid">
            <div class="chart-card" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div class="chart-title" id="lblTituloTotal">Ventas de Hoy</div>
                <div class="big-number" id="lblTotalHoy">C$ 0.00</div>
                <div class="subtitle" id="lblFechaHoy">-</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="chart-card" style="grid-column: span 2;">
                <div class="chart-title" id="lblTituloTendencia">Tendencia de Ventas (√öltimos 30 d√≠as)</div>
                <div class="chart-wrapper">
                    <canvas id="chartTendencia"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title" id="lblTituloTop">Top 5 Platillos (Hoy)</div>
                <div class="chart-wrapper">
                    <canvas id="chartProductos"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        Chart.defaults.color = '#8b8d91';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';
        
        const socket = io();

        socket.on('connect', () => {
            console.log("üü¢ Conectado para recibir actualizaciones en tiempo real");
        });

        socket.on('mesas_actualizadas', () => {
            console.log("üí∞ Nueva venta detectada. Actualizando gr√°ficas...");
            
            const start = document.getElementById('dateStart').value;
            const end = document.getElementById('dateEnd').value;
            
            loadData(start, end);
            
            const lblTotal = document.getElementById('lblTotalHoy');
            lblTotal.style.color = '#fff'; 
            setTimeout(() => {
                lblTotal.style.color = '#00d26a'; 
            }, 300);
        });



        let chartInstanceTendencia = null;
        let chartInstanceProductos = null;

        const dateStartInput = document.getElementById('dateStart');
        const dateEndInput = document.getElementById('dateEnd');

        dateStartInput.addEventListener('change', function() {
            dateEndInput.min = this.value;
            if (dateEndInput.value && dateEndInput.value < this.value) {
                dateEndInput.value = this.value;
            }
        });

        async function loadData(start = '', end = '') {
            try {
                let url = '/api/chart-data';
                if (start && end) {
                    url += `?start=${start}&end=${end}`;
                }

                const response = await fetch(url);
                if (response.status !== 200) throw new Error(`Error HTTP: ${response.status}`);

                const data = await response.json();
                if (data.error) {
                    alert("Error del servidor: " + data.error);
                    return;
                }
                
                renderDashboard(data, start, end);

            } catch (error) {
                console.error("Error JS:", error);
                alert("Ocurri√≥ un error al cargar los datos.");
            }
        }

        function applyFilter() {
            const start = dateStartInput.value;
            const end = dateEndInput.value;
            if(!start || !end) {
                alert("Por favor seleccione ambas fechas");
                return;
            }
            loadData(start, end);
        }

        function renderDashboard(data, start, end) {
            let totalRango = 0;
            if (data.tendencia && data.tendencia.totales) {
                totalRango = data.tendencia.totales.reduce((a, b) => a + b, 0);
            }

            document.getElementById('lblTotalHoy').textContent = 
                'C$ ' + totalRango.toLocaleString('en-US', {minimumFractionDigits: 2});

            if (start && end) {
                document.getElementById('lblTituloTotal').textContent = "Ventas del Periodo";
                document.getElementById('lblFechaHoy').textContent = `${start} al ${end}`;
                document.getElementById('lblTituloTendencia').textContent = `Tendencia (${start} al ${end})`;
                document.getElementById('lblTituloTop').textContent = `Top 5 Platillos (${start} al ${end})`;
            } else {
                const hoy = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('lblTituloTotal').textContent = "Ventas de Hoy";
                document.getElementById('lblFechaHoy').textContent = hoy;
                document.getElementById('lblTituloTendencia').textContent = "Tendencia de Ventas (√öltimos 30 d√≠as)";
                document.getElementById('lblTituloTop').textContent = "Top 5 Platillos (Hoy)";
            }

            const ctxTendencia = document.getElementById('chartTendencia').getContext('2d');
            if (chartInstanceTendencia) chartInstanceTendencia.destroy();

            let gradient = ctxTendencia.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(247, 102, 6, 0.5)');
            gradient.addColorStop(1, 'rgba(247, 102, 6, 0.0)');

            chartInstanceTendencia = new Chart(ctxTendencia, {
                type: 'line',
                data: {
                    labels: data.tendencia.fechas,
                    datasets: [{
                        label: 'Ventas (C$)',
                        data: data.tendencia.totales,
                        borderColor: '#f76606',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            const ctxProd = document.getElementById('chartProductos').getContext('2d');
            if (chartInstanceProductos) chartInstanceProductos.destroy();

            chartInstanceProductos = new Chart(ctxProd, {
                type: 'doughnut',
                data: {
                    labels: data.top_productos.nombres,
                    datasets: [{
                        data: data.top_productos.cantidades,
                        backgroundColor: ['#f76606', '#00d26a', '#29b6f6', '#ab47bc', '#ff7043'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        loadData();
    </script>
</body>
</html>